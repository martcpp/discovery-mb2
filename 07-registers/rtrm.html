<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>RTRM - Rust Embedded MB2 Discovery Book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="Discover the world of microcontrollers through Rust with the BB2 micro:bit v2">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Rust Embedded MB2 Discovery Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rust-embedded/discovery-mb2/" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="rtrm-reading-the-reference-manual"><a class="header" href="#rtrm-reading-the-reference-manual">RTRM: Reading The Reference Manual</a></h1>
<p>We have previously seen the GPIO pins on the nRF52833. On this chip (and on many others) the GPIO
pins are grouped into <em>ports</em>. There are two ports, Port 0 and Port 1, abbreviated to <code>P0</code> and <code>P1</code>
respectively. The pins within each port are named with numbers starting from 0. Port 0 has 32 pins,
named <code>P0.00</code> to <code>P0.31</code>, and Port 1 has 10 pins, named <code>P1.00</code> to <code>P1.09</code>.</p>
<p>The first thing we have to remember out is which pin is connected to which LED.  We previously did
this by tracing the schematic. That turns out to be hard mode: the required information is in the
MB2 <a href="https://tech.microbit.org/hardware/schematic/#v2-pinmap">pinmap table</a>.</p>
<p>The table says:</p>
<ul>
<li><code>ROW1</code>, the top LED row, is connected to the pin <code>P0.21</code>. <code>P0.21</code> is the short form of: Pin 21 on Port 0.</li>
<li><code>ROW5</code>, the bottom LED row, is connected to the pin <code>P0.19</code>.</li>
</ul>
<p>Up to this point, we know that we want to change the state of the pins <code>P0.21</code> and <code>P0.19</code> to turn
the top and bottom rows on and off. These pins are part of Port 0 so we'll use the <code>P0</code> peripheral
to set them up.</p>
<p>Each peripheral has a register <em>block</em> associated with it. A register block is a collection of
registers allocated in contiguous memory. The address at which the register block starts is known as
its base address. We need to figure out what's the base address of the <code>P0</code> peripheral. That
information is in the following section of the microcontroller <a href="https://docs.nordicsemi.com/bundle/nRF52833_PS_v1.6/resource/nRF52833_PS_v1.6.pdf">Product Specification</a>:</p>
<blockquote>
<p>Section 4.2.4 Instantiation - Page 22</p>
</blockquote>
<p>The table says that base address of the <code>P0</code> register block is <code>0x5000_0000</code>.</p>
<p>Each peripheral also has its own section in the documentation. Each of these sections ends with a
table of the registers that the peripheral's register block contains. For the <code>GPIO</code> family of
peripheral, that table is in:</p>
<blockquote>
<p>Section 6.8.2 Registers - Page 144</p>
</blockquote>
<p><code>OUT</code> is the register which we will be using to set/reset. Its offset value is <code>0x504</code> from the base
address of the <code>P0</code>. We can look up <code>OUT</code> in the reference manual.</p>
<p>That register is specified right under the <code>GPIO</code> registers table:</p>
<blockquote>
<p>Subsection 6.8.2.1 OUT - Page 145</p>
</blockquote>
<p>Anyway, <code>0x5000_0000</code> + <code>0x504</code> = <code>0x50000504</code>. That looks familiar! Finally!</p>
<p>This is the register we were writing to. The documentation says some interesting things. First, this
register can both be written to and read from. Next, the register is a 32-bit piece of memory, and
each bit represents the state of the corresponding pin. That means that bit 19 matches pin 19, for
instance.  Setting the bit to 1 will enable the pin output, and setting it to 0 will reset
it. Furthermore, we can see that all pin outputs are disabled by default, as the reset value of all
bits is 0.</p>
<p>We'll use GDB's <code>examine</code> command: <code>x</code>. Depending on the configuration of your GDB server,
GDB will refuse to read memory that isn't specified. You can disable this behaviour by running:</p>
<pre><code>set mem inaccessible-by-default off
</code></pre>
<p>So here we go. First turn off the <code>inaccessible-by-default</code> flag, then set a couple of breakpoints, reset the device and halt.</p>
<pre><code>(gdb) set mem inaccessible-by-default off
(gdb) break 16
Breakpoint 1 at 0x172: file src/07-registers/src/main.rs, line 16.
Note: automatically using hardware breakpoints for read-only addresses.
(gdb) break 19
Breakpoint 2 at 0x17c: file src/07-registers/src/main.rs, line 19.
(gdb) break 22
Breakpoint 3 at 0x184: file src/07-registers/src/main.rs, line 22.
(gdb) break 25
Breakpoint 4 at 0x18c: file src/07-registers/src/main.rs, line 25.
(gdb) monitor reset halt
Resetting and halting target
Target halted
</code></pre>
<p>All right. Let's continue until the first breakpoint, right before line 16, and print the contents
of the register at address <code>0x50000504</code>.</p>
<pre><code>(gdb) c
Continuing.

Breakpoint 1, registers::__cortex_m_rt_main () at src/07-registers/src/main.rs:16
16              *(PORT_P0_OUT as *mut u32) |= 1 &lt;&lt; 21;
(gdb) x 0x50000504
0x50000504:     0x00000000
</code></pre>
<p>Ok, we see that the register's value is <code>0x00000000</code> or <code>0</code> at this point. This corresponds with the
data in the product specification, which says that <code>0</code> is the 'reset value' of this register. That
means that once the MCU resets, the register will have <code>0</code> as its value.</p>
<p>Let's go on. This line consists of multiple instructions (reading, bitwise ORing and writing), so we
need to instruct the debugger to continue execution more than once, until we hit the next
breakpoint.</p>
<pre><code>(gdb) c
Continuing.

Program received signal SIGINT, Interrupt.
0x00000174 in registers::__cortex_m_rt_main () at src/07-registers/src/main.rs:16
16              *(PORT_P0_OUT as *mut u32) |= 1 &lt;&lt; 21;
(gdb) c
Continuing.

Breakpoint 2, registers::__cortex_m_rt_main () at src/07-registers/src/main.rs:19
19              *(PORT_P0_OUT as *mut u32) |= 1 &lt;&lt; 19;
</code></pre>
<p>We've stopped right before line 19, meaning that line 16 is fully executed at this point. Let's have
a look at the <code>OUT</code> register's contents again:</p>
<pre><code>(gdb) x 0x50000504
0x50000504:     0x00200000
</code></pre>
<p>The value of the <code>OUT</code> register is <code>0x00200000</code> at this point, which is <code>2097152</code> in decimal, or
<code>2^21</code>. That means that bit 21 is set to 1, and the rest of the bits is set to 0. That corresponds
to the code on line 16, which writes <code>1 &lt;&lt; 21</code>, or a 1 shifted left 21 positions, bitwise ORed with
<code>OUT</code>s current value (which was 0), to the <code>OUT</code> register.</p>
<p>Writing <code>1 &lt;&lt; 21</code> (<code>OUT[21]= 1</code>) to <code>OUT</code> sets <code>P0.21</code> <em>high</em>. That turns the top LED row
<em>on</em>. Check that the top row is now indeed lit up.</p>
<pre><code>(gdb) c
Continuing.
</code></pre>
<p>Yeah, I was gonna say that. Now, hit 'c' another time to continue execution up to the next
breakpoint and print its value.</p>
<pre><code>Program received signal SIGINT, Interrupt.
0x0000017e in registers::__cortex_m_rt_main () at src/07-registers/src/main.rs:19
19              *(PORT_P0_OUT as *mut u32) |= 1 &lt;&lt; 19;
(gdb) c
Continuing.

Breakpoint 3, registers::__cortex_m_rt_main () at src/07-registers/src/main.rs:22
22              *(PORT_P0_OUT as *mut u32) &amp;= !(1 &lt;&lt; 21);
(gdb) x 0x50000504
0x50000504:     0x00280000
</code></pre>
<p>On line 19, we've set bit 21 of <code>OUT</code> to 1, keeping bit 19 as is. The result is <code>0x00280000</code>, which
is <code>2621440</code> in decimal, or <code>2^19 + 2^21</code>, meaning that both bit 19 and bit 21 is set to 1.</p>
<p>Writing <code>1 &lt;&lt; 19</code> (<code>OUT[19]= 1</code>) to <code>OUT</code> sets <code>P0.19</code> <em>high</em>. That turns the bottom LED row
<em>on</em>. As such, the bottom row should now be lit up.</p>
<p>The following lines turn the rows off again. First the top row, then the bottom row. This time,
we're doing a bitwise AND operation, combined with a bitwise NOT. We calculate <code>!(1 &lt;&lt; 21)</code>, which
is all bits set to 1, except for bit 21. Next, we bitwise AND that with the current value of <code>OUT</code>,
ensuring that only bit 21 is set to 0, keeping the value of the other bits intact.</p>
<p>Continue execution and check that the reported values of the <code>OUT</code> register matches what you
expect. You can press <code>CTRL+C</code> to pause execution once the device enters the endless loop at the end
of the <code>main</code> function.</p>
<pre><code>(gdb) c
Continuing.

Program received signal SIGINT, Interrupt.
0x00000186 in registers::__cortex_m_rt_main () at src/07-registers/src/main.rs:22
22              *(PORT_P0_OUT as *mut u32) &amp;= !(1 &lt;&lt; 21);
(gdb) c
Continuing.

Breakpoint 4, registers::__cortex_m_rt_main () at src/07-registers/src/main.rs:25
25              *(PORT_P0_OUT as *mut u32) &amp;= !(1 &lt;&lt; 19);
(gdb) x 0x50000504
0x50000504:     0x00080000
(gdb) c
Continuing.

Program received signal SIGINT, Interrupt.
0x0000018e in registers::__cortex_m_rt_main () at src/07-registers/src/main.rs:25
25              *(PORT_P0_OUT as *mut u32) &amp;= !(1 &lt;&lt; 19);
(gdb) c
Continuing.
^C
Program received signal SIGINT, Interrupt.
0x00000196 in registers::__cortex_m_rt_main () at src/07-registers/src/main.rs:28
28          loop {}
(gdb) x 0x50000504
0x50000504:     0x00000000
</code></pre>
<p>And at this points all LEDs should be turned off again!</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../07-registers/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../07-registers/misoptimization.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../07-registers/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../07-registers/misoptimization.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../epub-link.js"></script>


    </div>
    </body>
</html>
